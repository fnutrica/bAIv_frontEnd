{% extends 'game/basic.html' %}

{% block custom_scripts %}
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<link rel="stylesheet" type="text/css" href="../../static/game/css/styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js"></script>
{% endblock %}

{% block title %} bAIv-homepage{% endblock %}

{% block body_block %}

<div class="container">

<div class="well">
        <center>
        </p><h1> <b> bAIv! </b></h1></p>  <h3> Read the scenario, choose your actions and simulate the market reaction. </h3>
        
        </center>
      </div>

  <div class="row">
  <div  id="game_prompt"  class = "col-md-7">
  <div class="well" style="background-color: lightyellow"  >
  <center><h3><b>Scenario</b></h3></center><br>
  <div id="prompt_text">  {{scenario_text}} </div>
  <br>
  <br>
 

  </div>
  </div>
 
    <div class ="col-md-5">
  <div class="well">

  <form action="/game/simulate" method="POST" id="input-form">
  {% csrf_token %}

  <div id="user_inputs" > </div>

  <br>
  <br>
  <center><b>
  <input style="background-color: orange; width: 100px; height: 40px;" type="submit" value="SIMULATE">  
  </b></center>
 </form>

 </div>
  </div>
<div id="game_data" class = "col-md-5">
  <div class="well">

  <center>

  <h3><b> PROGRESS </b></h3>

<table border="2" style="width:90%">
<tr>
<th></th>
<th><b> Value </b></th>
</tr>
<tr>
<td><b> Units Solds </b></td>
<td id = "units_sold">  </td>
</tr>
<tr>
<td><b> Total Profit </b></td>
<td id= "profit">  </td>
</tr>
<tr>
<td><b>  Customer Purchase "odds"  </b></td>
<td id = "likelihood">  </td>
</tr>
</table>
</center>
    
  </div>
  </div>

  
 
  <br>
 
  <div id="game_result" class = "col-md-12 col-md-offset-0">
  <div class="well" id="results_graph" style="display: none;" > 
  <canvas id="myChart" width="100%" height="50%">
  </canvas>


  </div>
  </div>
  
  </div>

</div>


 	<script> 

   var questions_string = '['+'{% for input in inputs %} {"question": "{{input}}", "answers": "{{input.answers}}" }, {% endfor %}'+' ])'
   var questions_string = questions_string.split(",  ])")[0]+"]"
   var questions = JSON.parse(questions_string);
   showQuestions(questions);

   


   function updateGraph(ctx, sim_data=null){
    restaurants = Object.keys(sim_data);  
    profits = []
    restaurants_values = Object.values(sim_data);


    for (rest in restaurants_values){
      profits.push(restaurants_values[rest].profit) 
    }

    var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: restaurants,
        datasets: [{
            label: 'Profit',
            data: profits,
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(86, 159, 64, 0.2)',
                'rgba(54, 162, 132, 0.2)',
                'rgba(192, 206, 86, 0.2)',
                'rgba(255, 99, 192, 0.2)'
            ],
            borderColor: [
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(255,99,132,1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }]
        }
    }
});

   }
   


  function showQuestions(questions){
    formDiv = document.getElementById("user_inputs");
    formDiv.innerHTML = "";
    for (question in questions){
   var questionDiv = document.createElement("div");
   questionDiv.innerHTML = questionDiv.innerHTML + "<h3><b>" + questions[question].question + "</b></h3>"
   questionDiv.id = "question-" + question;

   var answersDiv = document.createElement("select");
   answersDiv.form = "input-form";
   answers= questions[question].answers;
   answers=answers.split(", ")
   for (answer in answers){
    var opt = document.createElement("option");
    opt.textContent = answers[answer];
    opt.value = answers[answer];
    answersDiv.appendChild(opt);
   }
   questionDiv.appendChild(answersDiv);
   formDiv.appendChild(questionDiv);
}
   
  }

 $('#input-form').on('submit', function(event){
    event.preventDefault();
    console.log("form submitted!"); //sanity check
    data={"questions": questions, "scenario_id": '{{scenario_id}}',"order_n": '{{scenario_order_n}}'};
    for (question in questions){
      selector="#question-"+question + " :selected";
      data[questions[question].question] = $(selector).text()
      }

    simulate(data);
    
});


  function simulate(my_data) {
    console.log("Simulating...") // sanity check
    $.ajax({
        url : "/game/simulate", // the endpoint
        type : "POST", // http method
        data : my_data, // data sent with the post request
        // handle a successful response
        success : function(response) {
            console.log("success"); // another sanity check
            updateData(response);
        },
        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom          
        }
    });
};

  function updateData(responseData){
    new_scenario_text = responseData['scenario_text'];
    questions = responseData['inputs'];
    sim_results = responseData['restaurants'];

    //add sim results in table
    //profit = sim_results[player]['profit'];
    //likelihood = sim_results.player['likelihood'];
    //units_sold = sim_results.player['units_sold'];

    /*
    for (get_data in sim_results){
        profit += sim_results[get_data]["profit"];
        likelihood += sim_results[get_data]["likelihood"];
        units_sold += sim_results[get_data]["units_sold"];
    }
    */

    if (profit>=0){
      $("#profit").text("$"+profit);
    }
    else {
      $("#profit").text("- $"+profit);
    }
    //$("#likelihood").text(likelihood+"%");
    //$("#units_sold").text(units_sold);
    $("#results_graph").css({"display": "block"});
    updateGraph($("#myChart"), sim_results);


    questions = JSON.parse(questions);
    $("#prompt_text").text(new_scenario_text);
    for (question in questions){
      questions[question].question=questions[question].fields.question;
      questions[question].answers = questions[question].fields.answers;
    }
    $("#prompt_text").text(new_scenario_text);
    showQuestions(questions);
   
  }//updateData

</script>

{% endblock %}

